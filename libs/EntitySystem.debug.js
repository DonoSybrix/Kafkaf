'use strict';var ES={Component:function(){}};ES.Entity=function(a){this.id=ES.Entity.prototype.nextID++;this.world=a};ES.Entity.prototype.nextID=0;ES.Entity.prototype.addComponent=function(a){this.world.sendEvent(new ES.EntityEvent(this,ES.EntityEvent.Type.AddComponent,a))};ES.Entity.prototype.removeComponent=function(a){this.world.sendEvent(new ES.EntityEvent(this,ES.EntityEvent.Type.RemoveComponent,a))};ES.Entity.prototype.setName=function(a){this.world.setEntityName(a,this)};ES.Entity.prototype.getComponents=function(){return this.world.getComponents(this)};
ES.Entity.prototype.getComponent=function(a){return this.world.getComponent(this,a)};ES.Event=function(){};ES.System=function(a){this.entities=[];this.enabled=!0;this.key=0;this.world=null;if(a)for(var b=0;b<a.length;b++)this.key|=a[b].prototype.UID};ES.System.prototype.addEntity=function(a){this.entities[this.entities.length]=a;this.onEntityAdded(a)};ES.System.prototype.removeEntity=function(a){var b=this.entities.indexOf(a);-1<b&&(this.entities.splice(b,1),this.onEntityRemoved(a))};ES.System.prototype.isPresent=function(a){return-1<this.entities.indexOf(a)};
ES.System.prototype.setActif=function(a){this.enabled=a};ES.System.prototype.update=function(a){};ES.System.prototype.onActivation=function(){};ES.System.prototype.onInactivation=function(){};ES.System.prototype.onEntityAdded=function(a){};ES.System.prototype.onEntityRemoved=function(a){};ES.System.prototype.onEvent=function(a){};ES.Utils=function(){};ES.Utils.nextID=0;ES.Utils.extend=function(a,b){goog.inherits(b,a);b.prototype.UID=1<<ES.Utils.nextID;ES.Utils.nextID++};ES.EntityEvent=function(a,b,c){ES.Event.call(this);this.entity=a;this.type=b;this.component=c};goog.inherits(ES.EntityEvent,ES.Event);ES.EntityEvent.Type={AddComponent:0,RemoveComponent:1};ES.World=function(){this.components=[];this.entities=[];this.waitingEvents=[];this.waitingAddUpdate=[];this.waitingRemoveUpdate=[];this.systems=[];this.entitiesNames=[]};ES.World.prototype.clear=function(){this.removeEntities();this.systems=[]};ES.World.prototype.removeEntities=function(){for(var a=0;a<this.systems.length;a++)this.systems[a].entities=[];this.entities=[];this.components=[];this.entitiesNames=[];this.waitingRemoveUpdate=[];this.waitingAddUpdate=[];this.waitingEvents=[]};
ES.World.prototype.createEntity=function(){var a=new ES.Entity(this);return this.entities[this.entities.length]=a};ES.World.prototype.destroyEntity=function(a){this.components[a.id]=[];this.waitingRemoveUpdate[a.id]=a;for(var b in this.entitiesNames)this.entitiesNames[b]==a&&(this.entitiesNames[b]=null)};ES.World.prototype.addSystem=function(a){a.world=this;this.systems[this.systems.length]=a};
ES.World.prototype.update=function(a){for(var b=0;b<this.waitingEvents.length;b++){var c=this.waitingEvents[b],d=this.components[c.entity.id]||[];switch(c.type){case ES.EntityEvent.Type.AddComponent:this.waitingAddUpdate[c.entity.id]=c.entity;break;case ES.EntityEvent.Type.RemoveComponent:d[c.component.UID]&&(delete d[c.component.UID],d[c.component.UID]=null,this.waitingRemoveUpdate[c.entity.id]=c.entity)}this.components[c.entity.id]=d}for(var e in this.waitingAddUpdate){var d=this.components[e],
c=0,f;for(f in d)d[f]&&(c|=f);for(b=0;b<this.systems.length;b++)0!=this.systems[b].key&&(c&this.systems[b].key)==this.systems[b].key&&this.systems[b].addEntity(this.waitingAddUpdate[e])}for(e in this.waitingRemoveUpdate){d=this.components[e];c=0;for(f in d)d[f]&&(c|=f);for(b=0;b<this.systems.length;b++)this.systems[b].isPresent(this.waitingRemoveUpdate[e])&&(c&this.systems[b].key)!=this.systems[b].key&&this.systems[b].removeEntity(this.waitingRemoveUpdate[e])}for(b=0;b<this.systems.length;b++)this.systems[b].enabled&&
this.systems[b].update(a);this.waitingEvents=[];this.waitingAddUpdate=[];this.waitingRemoveUpdate=[]};ES.World.prototype.sendEvent=function(a){if(a instanceof ES.EntityEvent){if(a.type==ES.EntityEvent.Type.AddComponent){var b=this.components[a.entity.id]||[];b[a.component.UID]=a.component;this.components[a.entity.id]=b}this.waitingEvents[this.waitingEvents.length]=a}for(b=0;b<this.systems.length;b++)this.systems[b].onEvent(a)};ES.World.prototype.setEntityName=function(a,b){this.entitiesNames[a]=b};
ES.World.prototype.getComponents=function(a){return this.components[a.id]||[]};ES.World.prototype.getComponent=function(a,b){var c=this.getComponents(a);return c?c[b.prototype.UID]||null:null};ES.World.prototype.getSystem=function(a){for(var b=0;b<this.systems.length;b++)if(this.systems[b]instanceof a)return this.systems[b];return null};ES.World.prototype.getEntityWithName=function(a){return this.entitiesNames[a]||null};
