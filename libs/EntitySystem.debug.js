'use strict';var ES={Component:function(){}};ES.Entity=function(b){this.id=ES.Entity.prototype.nextID++;this.world=b};ES.Entity.prototype.nextID=0;ES.Entity.prototype.addComponent=function(b){this.world.sendEvent(new ES.EntityEvent(this,ES.EntityEvent.Type.AddComponent,b))};ES.Entity.prototype.removeComponent=function(b){this.world.sendEvent(new ES.EntityEvent(this,ES.EntityEvent.Type.RemoveComponent,b))};ES.Entity.prototype.setName=function(b){this.world.setEntityName(b,this)};ES.Entity.prototype.getComponents=function(){return this.world.getComponents(this)};
ES.Entity.prototype.getComponent=function(b){return this.world.getComponent(this,b)};ES.Event=function(){};ES.System=function(b){this.entities=[];this.enabled=!0;this.key=0;this.world=null;if(b)for(var a=0;a<b.length;a++)this.key|=b[a].prototype.UID};ES.System.prototype.addEntity=function(b){this.entities[this.entities.length]=b;this.onEntityAdded(b)};ES.System.prototype.removeEntity=function(b){var a=this.entities.indexOf(b);-1<a&&(this.entities.splice(a,1),this.onEntityRemoved(b))};ES.System.prototype.isPresent=function(b){return-1<this.entities.indexOf(b)};
ES.System.prototype.setActif=function(b){this.enabled=b};ES.System.prototype.update=function(b){};ES.System.prototype.onActivation=function(){};ES.System.prototype.onInactivation=function(){};ES.System.prototype.onEntityAdded=function(b){};ES.System.prototype.onEntityRemoved=function(b){};ES.System.prototype.onEvent=function(b){};ES.Utils=function(){};ES.Utils.nextID=0;ES.Utils.extend=function(b,a){goog.inherits(a,b);a.prototype.UID=1<<ES.Utils.nextID;ES.Utils.nextID++};ES.EntityEvent=function(b,a,c){ES.Event.call(this);this.entity=b;this.type=a;this.component=c};goog.inherits(ES.EntityEvent,ES.Event);ES.EntityEvent.Type={AddComponent:0,RemoveComponent:1};ES.World=function(){this.components=[];this.entities=[];this.waitingEvents=[];this.waitingAddUpdate=[];this.waitingRemoveUpdate=[];this.systems=[];this.entitiesNames=[]};ES.World.prototype.clear=function(){this.removeEntities();this.systems=[]};ES.World.prototype.removeEntities=function(){for(var b=0;b<this.systems.length;b++)this.systems[b].entities=[];this.entities=[];this.components=[];this.entitiesNames=[];this.waitingRemoveUpdate=[];this.waitingAddUpdate=[];this.waitingEvents=[]};
ES.World.prototype.createEntity=function(){var b=new ES.Entity(this);return this.entities[this.entities.length]=b};ES.World.prototype.destroyEntity=function(b){this.waitingRemoveUpdate[this.waitingRemoveUpdate.length]={entity:b,components:[]};for(var a in this.entitiesNames)this.entitiesNames[a]==b&&(this.entitiesNames[a]=null)};ES.World.prototype.addSystem=function(b){b.world=this;this.systems[this.systems.length]=b};
ES.World.prototype.update=function(b){for(var a=0;a<this.waitingEvents.length;a++){var c=this.waitingEvents[a],e=this.components[c.entity.id]||[];switch(c.type){case ES.EntityEvent.Type.AddComponent:this.waitingAddUpdate[c.entity.id]=c.entity;break;case ES.EntityEvent.Type.RemoveComponent:e[c.component.UID]&&(this.waitingRemoveUpdate[this.waitingRemoveUpdate.length]=this.waitingRemoveUpdate[c.entity.id]||{entity:c.entity,components:[]},this.waitingRemoveUpdate[c.entity.id].components[this.waitingRemoveUpdate[c.entity.id].components.length]=
c.component.UID)}this.components[c.entity.id]=e}this.waitingEvents=[];for(var d in this.waitingAddUpdate){var e=this.components[d],c=0,f;for(f in e)e[f]&&(c|=f);for(a=0;a<this.systems.length;a++)0!=this.systems[a].key&&(c&this.systems[a].key)==this.systems[a].key&&this.systems[a].addEntity(this.waitingAddUpdate[d])}this.waitingAddUpdate=[];for(a=0;a<this.waitingRemoveUpdate.length;a++)if(d=this.waitingRemoveUpdate[a],0==d.components.length){for(a=0;a<this.systems.length;a++)this.systems[a].isPresent(d.entity)&&
this.systems[a].removeEntity(d.entity);for(a in this.components[d.entity.id])delete this.components[d.entity.id][a];this.components[d.entity.id]=[]}else{e=this.components[d.entity.id];c=0;for(f in e)e[f]&&(c|=f);for(a=0;a<this.systems.length;a++)this.systems[a].isPresent(d.entity)&&(c&this.systems[a].key)!=this.systems[a].key&&this.systems[a].removeEntity(d.entity);for(a in d.components)delete e[a],e[a]=null}this.waitingRemoveUpdate=[];for(a=0;a<this.systems.length;a++)this.systems[a].enabled&&this.systems[a].update(b)};
ES.World.prototype.sendEvent=function(b){if(b instanceof ES.EntityEvent){if(b.type==ES.EntityEvent.Type.AddComponent){var a=this.components[b.entity.id]||[];a[b.component.UID]=b.component;this.components[b.entity.id]=a}this.waitingEvents[this.waitingEvents.length]=b}for(a=0;a<this.systems.length;a++)this.systems[a].onEvent(b)};ES.World.prototype.setEntityName=function(b,a){this.entitiesNames[b]=a};ES.World.prototype.getComponents=function(b){return this.components[b.id]||[]};
ES.World.prototype.getComponent=function(b,a){var c=this.getComponents(b);return c?c[a.prototype.UID]||null:null};ES.World.prototype.getSystem=function(b){for(var a=0;a<this.systems.length;a++)if(this.systems[a]instanceof b)return this.systems[a];return null};ES.World.prototype.getEntityWithName=function(b){return this.entitiesNames[b]||null};
